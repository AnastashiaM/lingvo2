var models = require('./models'), Natural = require('natural'), sanitizeHtml = require('sanitize-html');

module.exports = {
    set: function(id) {
        try {

            var tokenizer = new Natural.WordTokenizer(),
                dicts = [
                    { name: 'general', words: ["a","about","above","across","act","active","activity","add","afraid","after","again","age","ago","agree","air","all","alone","along","already","always","am","amount","an","and","angry","another","answer","any","anyone","anything","anytime","appear","apple","are","area","arm","army","around","arrive","art","as","ask","at","attack","aunt","autumn","away","baby","base","back","bad","bag","ball","bank","basket","bath","be","bean","bear","beautiful","beer","bed","bedroom","behave","before","begin","behind","bell","below","besides","best","better","between","big","bird","birth","birthday","bit","bite","black","bleed","block","blood","blow","blue","board","boat","body","boil","bone","book","border","born","borrow","both","bottle","bottom","bowl","box","boy","branch","brave","bread","break","breakfast","breathe","bridge","bright","bring","brother","brown","brush","build","burn","business","bus","busy","but","buy","by","cake","call","can","candle","cap","car","card","care","careful","careless","carry","case","cat","catch","central","century","certain","chair","chance","change","chase","cheap","cheese","chicken","child","children","chocolate","choice","choose","circle","city","class","clever","clean","clear","climb","clock","cloth","clothes","cloud","cloudy","close","coffee","coat","coin","cold","collect","colour","comb","come","comfortable","common","compare","complete","computer","condition","continue","control","cook","cool","copper","corn","corner","correct","cost","contain","count","country","course","cover","crash","cross","cry","cup","cupboard","cut","dance","dangerous","dark","daughter","day","dead","decide","decrease","deep","deer","depend","desk","destroy","develop","die","different","difficult","dinner","direction","dirty","discover","dish","do","dog","door","double","down","draw","dream","dress","drink","drive","drop","dry","duck","dust","duty","each","ear","early","earn","earth","east","easy","eat","education","effect","egg","eight","either","electric","elephant","else","empty","end","enemy","enjoy","enough","enter","equal","entrance","escape","even","evening","event","ever","every","everyone","exact","everybody","examination","example","except","excited","exercise","expect","expensive","explain","extremely","eye","face","fact","fail","fall","false","family","famous","far","farm","father","fast","fat","fault","fear","feed","feel","female","fever","few","fight","fill","film","find","fine","finger","finish","fire","first","fit","five","fix","flag","flat","float","floor","flour","flower","fly","fold","food","fool","foot","football","for","force","foreign","forest","forget","forgive","fork","form","fox","four","free","freedom","freeze","fresh","friend","friendly","from","front","fruit","full","fun","funny","furniture","further","future","game","garden","gate","general","gentleman","get","gift","give","glad","glass","go","goat","god","gold","good","goodbye","grandfather","grandmother","grass","grave","great","green","grey","ground","group","grow","gun","hair","half","hall","hammer","hand","happen","happy","hard","hat","hate","have","he","head","healthy","hear","heavy","hello","help","heart","heaven","height","help","hen","her","here","hers","hide","high","hill","him","his","hit","hobby","hold","hole","holiday","home","hope","horse","hospital","hot","hotel","house","how","hundred","hungry","hour","hurry","husband","hurt","I","ice","idea","if","important","in","increase","inside","into","introduce","invent","iron","invite","is","island","it","its","jelly","job","join","juice","jump","just","keep","key","kill","kind","king","kitchen","knee","knife","knock","know","ladder","lady","lamp","land","large","last","late","lately","laugh","lazy","lead","leaf","learn","leave","leg","left","lend","length","less","lesson","let","letter","library","lie","life","light","like","lion","lip","list","listen","little","live","lock","lonely","long","look","lose","lot","love","low","lower","luck","machine","main","make","male","man","many","map","mark","market","marry","matter","may","me","meal","mean","measure","meat","medicine","meet","member","mention","method","middle","milk","million","mind","minute","miss","mistake","mix","model","modern","moment","money","monkey","month","moon","more","morning","most","mother","mountain","mouth","move","much","music","must","my","name","narrow","nation","nature","near","nearly","neck","need","needle","neighbour","neither","net","never","new","news","newspaper","next","nice","night","nine","no","noble","noise","none","nor","north","nose","not","nothing","notice","now","number","obey","object","ocean","of","off","offer","office","often","oil","old","on","one","only","open","opposite","or","orange","order","other","our","out","outside","over","own","page","pain","paint","pair","pan","paper","parent","park","part","partner","party","pass","past","path","pay","peace","pen","pencil","people","pepper","per","perfect","period","person","petrol","photograph","piano","pick","picture","piece","pig","pin","pink","place","plane","plant","plastic","plate","play","please","pleased","plenty","pocket","point","poison","police","polite","pool","poor","popular","position","possible","potato","pour","power","present","press","pretty","prevent","price","prince","prison","private","prize","probably","problem","produce","promise","proper","protect","provide","public","pull","punish","pupil","push","put","queen","question","quick","quiet","quite","radio","rain","rainy","raise","reach","read","ready","real","really","receive","record","red","remember","remind","remove","rent","repair","repeat","reply","report","rest","restaurant","result","return","rice","rich","ride","right","ring","rise","road","rob","rock","room","round","rubber","rude","rule","ruler","run","rush","sad","safe","sail","salt","same","sand","save","say","school","science","scissors","search","seat","second","see","seem","sell","send","sentence","serve","seven","several","sex","shade","shadow","shake","shape","share","sharp","she","sheep","sheet","shelf","shine","ship","shirt","shoe","shoot","shop","short","should","shoulder","shout","show","sick","side","signal","silence","silly","silver","similar","simple","single","since","sing","sink","sister","sit","six","size","skill","skin","skirt","sky","sleep","slip","slow","smoke","small","smell","smile","smoke","snow","so","soap","sock","soft","some","someone","something","sometimes","son","soon","sorry","sound","soup","south","space","speak","special","speed","spell","spend","spoon","sport","spread","spring","square","stamp","stand","star","start","station","stay","steal","steam","step","still","stomach","stone","stop","store","storm","story","strange","street","strong","structure","student","study","stupid","subject","substance","successful","such","sudden","sugar","suitable","summer","sun","sunny","support","sure","surprise","sweet","swim","sword","table","take","talk","tall","taste","taxi","tea","teach","team","tear","telephone","television","tell","ten","tennis","terrible","test","than","that","the","their","then","there","therefore","these","thick","thin","thing","think","third","this","though","threat","three","tidy","tie","title","to","today","toe","together","tomorrow","tonight","too","tool","tooth","top","total","touch","town","train","tram","travel","tree","trouble","true","trust","twice","try","turn","type","uncle","under","understand","unit","until","up","use","useful","usual","usually","vegetable","very","village","voice","visit","wait","wake","walk","want","warm","wash","waste","watch","water","way","we","weak","wear","weather","wedding","week","weight","welcome","well","west","wet","what","wheel","when","where","which","while","white","who","why","wide","wife","wild","will","win","wind","window","wine","winter","wire","wise","wish","with","without","woman","wonder","word","work","world","worry","worst","write","wrong","year","yes","yesterday","yet","you","young","your","zero","zoo"] },
                    { name: 'toefl', words: ["abandon", "abate", "abbreviation", "abduct", "abhor", "abject", "abolish", "abort", "abrupt", "absolve", "abstain", "abstruse", "absurd", "abundant", "abyss", "accessible", "acclaim", "accomplice", "accurate", "accuse", "acid", "acquaint", "acquiesce", "acrid", "actuate", "acute", "adamant", "adapt", "adept", "adequate", "adhere", "adjacent", "admonish", "adorn", "advent", "adverse", "advocate", "affable", "affect", "affiliate", "affinity", "affliction", "affluent", "aggravate", "aggregate", "agile", "agitate", "agrarian", "ailment", "akin", "allegiance", "alleviate", "allocate", "allot", "allude", "aloft", "aloof", "alternative", "amazing", "ambiguous", "ambivalence", "ambivalent", "amenable", "amiable", "amicable", "amnesia", "amnesty", "amphitheater", "analogous", "anecdote", "annex", "annual", "anonymous", "antagonism", "antagonist", "antedate", "anticipate", "antique", "anxious", "apathy", "apparent", "appealing", "appease", "applaud", "appraise", "apprise", "approbation", "apt", "arable", "arduous", "arid", "aroma", "arrogant", "articulate", "artificial", "ascertain", "assail", "assault", "assert", "assiduous", "assimilate", "astonishing", "astute", "atone", "atrocity", "attain", "attribute", "audacious", "auditory", "augment", "august", "austere", "authentic", "authorize", "automaton", "autonomy", "avalanche", "avarice", "aver", "aversion", "avert", "aviator", "avid", "avoid", "awkward", "bacchanalian", "bachelor", "baffle", "bald", "balmy", "ban", "bankrupt", "bar", "bare", "barren", "barter", "bashful", "bead", "beam", "bear", "beckon", "bellicose", "belligerent", "beneficial", "beneficiary", "benefit", "benevolent", "bequeath", "besiege", "bestow", "betray", "beverage", "bias", "bicker", "bilateral", "biography", "bland", "blatant", "blend", "blizzard", "bloom", "bluff", "blunder", "blunt", "bold", "bolster", "bond", "boom", "brace", "breakthrough", "breathtaking", "breed", "breeze", "brilliant", "brisk", "brittle", "broach", "brochure", "brutal", "bulky", "burrow", "buttress", "cajole", "calamity", "calm", "camouflage", "canvass", "capable", "captivate", "caricature", "carnage", "carve", "cast", "casual", "cataclysm", "catastrophe", "caustic", "cautious", "cavity", "celebrated", "censor", "censure", "census", "centennial", "chaos", "chasm", "cherish", "chicanery", "chide", "chilly", "chop", "chubby", "cite", "clandestine", "clash", "classify", "cliche", "cling", "clumsy", "coalescence", "coalition", "coax", "coherent", "coin", "collaborate", "colossal", "commence", "commerce", "commitment", "commodity", "compact", "compel", "competent", "compile", "complement", "compliment", "comply", "component", "comprehensible", "comprehensive", "comprise", "compulsory", "concede", "concerted", "concise", "concoct", "concord", "concrete", "concurrent", "condemn", "confer", "confidential", "configuration", "confiscate", "conflict", "conform", "congenial", "congestion", "conglomerate", "congregate", "conjecture", "consecutive", "consistent", "conspicuous", "contaminate", "contemplate", "contempt", "contention", "contrive", "controversial", "controversy", "convenient", "convey", "conviction", "copious", "cordial", "corporeal", "corpulent", "corroborate", "courteous", "covert", "cozy", "crave", "crease", "crooked", "crouch", "crucial", "crude", "cryptic", "cultivate", "cumbersome", "cumulative", "curb", "curious", "curt", "curtail", "damp", "dangle", "daring", "daunt", "dazzling", "decadent", "decay", "deceit", "deception", "decipher", "declare", "declivity", "decompose", "decorate", "dedicate", "deem", "defame", "defect", "defective", "defer", "deficient", "definitive", "defraud", "degenerate", "dehydrate", "deity", "dejected", "deliberate", "delicate", "deluge", "delusion", "demise", "demolish", "denote", "denounce", "dense", "depress", "deprive", "derelict", "deride", "descry", "desecrate", "deserted", "desiccate", "desist", "desolate", "desultory", "detect", "deteriorate", "detrimental", "deviate", "device", "devise", "devoid", "dexterous", "digress", "diligent", "dilute", "dim", "dimension", "dingy", "dip", "discard", "discern", "discipline", "disclose", "discord", "discrepancy", "disdain", "dismal", "dismay", "disparity", "disperse", "disposition", "dispute", "disseminate", "dissolve", "distinct", "distinguished", "distract", "diverge", "divulge", "docile", "dodge", "dogged", "doleful", "dominate", "donate", "dot", "doze", "drain", "drastic", "drawback", "dreary", "drench", "drip", "drought", "drowsy", "dubious", "dull", "dumbfound", "dunce", "durable", "dwell", "dwelling", "dwindle", "dynamic", "eclipse", "ecology", "edible", "edifice", "eerie", "efface", "elaborate", "elasticity", "elderly", "elegant", "elevate", "elicit", "eligible", "elucidate", "elude", "emanate", "emancipate", "embed", "emblem", "emboss", "eminent", "emit", "emulate", "enamored", "enchant", "enchanting", "encomium", "encounter", "endeavor", "endorse", "engender", "enhance", "enigma", "enlist", "enmity", "ennui", "ensue", "enthrall", "entice", "enumerate", "enunciate", "envisage", "ephemeral", "epitaph", "epithet", "equitable", "equivocal", "eradicate", "erect", "escalate", "eschew", "espouse", "essay", "essential", "estate", "esteem", "eulogy", "evacuate", "evade", "evanescent", "evenhanded", "evolve", "exacerbate", "exacting", "exalt", "excavate", "exceed", "excerpt", "excursion", "execute", "exhaustive", "exhilarating", "exhortation", "expendable", "expire", "explicit", "exploit", "explore", "expose", "expunge", "extensive", "extol", "extract", "extraneous", "extravagant", "facet", "facile", "facilitate", "facility", "fade", "faint", "fake", "falter", "famine", "fancy", "fare", "fasten", "fatal", "fatigue", "feasible", "feat", "fee", "feeble", "feign", "felicity", "ferocious", "fertile", "fervent", "fickle", "fidelity", "finance", "finite", "fitting", "flagrant", "flaw", "flee", "flexible", "flimsy", "flip", "florid", "fluctuate", "foggy", "fold", "forego", "foremost", "forestall", "forlorn", "formative", "foul", "fragile", "fragment", "fragrant", "frail", "framework", "fraud", "fraudulent", "frenetic", "frustrate", "fugitive", "fundamental", "fuse", "fusion", "futile", "gainsay", "gale", "gap", "garrulous", "gaudy", "genial", "gentle", "genuine", "germane", "germinate", "ghastly", "glisten", "glitter", "glorify", "glossy", "goad", "gorgeous", "grab", "grace", "graphic", "grasp", "gratuitous", "grave", "gravity", "graze", "gregarious", "grim", "grip", "gross", "grueling", "grumble", "guile", "gullible", "gusto", "haggle", "hamper", "handy", "haphazard", "harangue", "harass", "harmony", "harness", "harsh", "hasty", "haul", "havoc", "hazardous", "hector", "hedonist", "heed", "heighten", "herald", "heretic", "heterogeneous", "hilarious", "hinder", "hoax", "hoist", "holocaust", "homogeneous", "hospitable", "hospitality", "hostage", "hostile", "hub", "hue", "humiliate", "hurl", "hyperbole", "hypocrite", "ideal", "idiosyncrasy", "idle", "illiterate", "illusion", "illustrate", "imaginary", "imbibe", "immense", "imminent", "immortal", "immune", "immutable", "impair", "impartial", "impecunious", "impediment", "impel", "impending", "imperceptible", "implement", "impose", "impromptu", "improvise", "impute", "incandescent", "incense", "incentive", "incessant", "incipient", "incise", "incognito", "incompatible", "incongruous", "increment", "incriminate", "incumbent", "indict", "indifferent", "indigenous", "indigent", "indignant", "indiscriminate", "indispensable", "induce", "inept", "inevitable", "infamous", "infinite", "infinitesimal", "infringe", "infuriate", "ingenious", "ingenuous", "ingredient", "inhabit", "inherent", "inhibit", "inimical", "initial", "injurious", "innate", "innocuous", "innovative", "inopportune", "inordinate", "inroad", "insinuate", "insipid", "insolent", "insolvent", "inspire", "instantaneous", "instigate", "insult", "insurrection", "intact", "integral", "intelligible", "intense", "interim", "interminable", "intervene", "intimate", "intimidate", "intractable", "intrepid", "intricate", "intrigue", "intrude", "invaluable", "inventory", "inveterate", "invincible", "inviting", "involuntary", "irate", "irreversible", "irrevocable", "irritable", "itinerant", "jagged", "jeopardy", "jolly", "jolt", "jovial", "judicious", "juncture", "juvenile", "keen", "knack", "lag", "laggard", "landscape", "landslide", "languid", "lapse", "lassitude", "latent", "laud", "lavish", "lax", "leaflet", "legendary", "legitimate", "lenient", "lethal", "lethargic", "levity", "lewd", "liable", "liaison", "licentious", "linger", "link", "loathsome", "locate", "locomotion", "lofty", "loom", "lucid", "lucrative", "lugubrious", "lull", "lullaby", "lumber", "luminous", "lunatic", "lure", "lurid", "lurk", "luster", "lustrous", "luxurious", "magnificent", "magnify", "magnitude", "makeup", "malady", "malediction", "malice", "malign", "malignant", "mandatory", "manifest", "mar", "maritime", "marked", "massacre", "masterpiece", "mature", "maxim", "meager", "meddle", "mediate", "meek", "memorable", "menace", "mend", "mercurial", "merge", "mesmerize", "meteor", "meticulous", "mingle", "minuscule", "minute", "mirth", "misappropriate", "misdemeanor", "misrepresent", "mock", "moderate", "molest", "monitor", "monotonous", "monumental", "morale", "morbid", "mortify", "mournful", "mundane", "murky", "mute", "mysterious", "mythical", "nausea", "neglect", "negligible", "nibble", "nimble", "nocturnal", "notable", "notify", "notion", "notorious", "novel", "novice", "noxious", "obese", "obituary", "objective", "oblique", "oblivious", "oblong", "obscene", "obscure", "obsequious", "obsolete", "obstinate", "obtrude", "obvious", "odd", "odor", "offhand", "offspring", "omen", "ominous", "ooze", "opportune", "orbit", "ordeal", "ornamental", "ostracize", "outgoing", "outlet", "outlook", "outrage", "outskirt", "outstanding", "overall", "overcast", "overcome", "overdue", "overlook", "override", "overrun", "oversee", "oversight", "overt", "overtake", "overwhelm", "pace", "pacifist", "pacify", "pact", "painstaking", "pale", "paltry", "panacea", "panic", "particle", "path", "patronage", "peculiar", "pedantic", "penetrate", "perceive", "perceptible", "perch", "perennial", "perforate", "peril", "perilous", "periodic", "permeate", "pernicious", "perpetual", "perplexing", "persecute", "pertain", "pertinent", "pervade", "petulant", "pierce", "pillage", "placate", "placid", "plague", "plausible", "plead", "plethora", "poise", "poky", "ponder", "portion", "portray", "posthumous", "postpone", "potent", "pounce", "preach", "precarious", "precept", "precious", "precipitation", "precise", "predicament", "preface", "prerogative", "presage", "prescribe", "presumptuous", "pretense", "pretext", "prevail", "prevalent", "prior", "probe", "proclaim", "procure", "prodigal", "prodigious", "profane", "profound", "profuse", "proliferate", "prolific", "prolong", "prominent", "promiscuous", "prompt", "pronounced", "propriety", "proscribe", "prosper", "protagonist", "provenance", "provisional", "provoke", "prudent", "pseudonym", "pulverize", "pungent", "pursue", "puzzling" ] }
                ],
                counter = 0;

            models.Episode.find({ 'processed': { $ne: id } }).limit(2000).exec(function(err, episodes) {
                console.log(episodes);
                episodes.forEach(function(episode) {
                    var tokens = tokenizer.tokenize(sanitizeHtml(episode.description, { allowedTags: [] }));

                    dicts.forEach(function(dict) {
                        var count = 0,
                        hits = 0,
                        used = [];

                        tokens.forEach(function(token) {
                            if (used.indexOf(token) == -1) {
                                count++;
                                if (dict.words.indexOf(token) != -1) {
                                    hits++;
                                }
                                used.push(token);
                            }

                            if (hits/count > 0.4 && episode.lexica.indexOf(dict.name) == -1)
                                (episode.lexica && episode.lexica instanceof Array ?
                                    episode.lexica.push(dict.name) : episode.category = [dict.name]);

                        });
                    });

                    episode.processed = id;

                    episode.save();

                    console.log('processed ' + ++counter + ' episodes');

                });

            });

        } catch (e) {}
    }
};

